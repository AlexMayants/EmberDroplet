"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(e,t,r){var n,i,s,a,o,u=t.Mixin,l=t.String,p=t.computed,f=t.get,c=t.set,d=t.run,h={NONE:0,VALID:1,INVALID:2,DELETED:4,UPLOADED:8,FAILED:16},m=t.Object.extend({init:function(){this.statusType=h.NONE},getMIMEType:function(){return this.file.type||""},getFileSize:function(){return"undefined"!=typeof this.file.size?this.file.size:1/0},setStatusType:function(e){this.set("statusType",Number(e))}}),g={PUSH:"push",SET:"set"},y={requestMethod:"POST",maximumSize:1/0,includeHeader:!0,useArray:!1,mimeTypes:["image/jpeg","image/jpg","image/gif","image/png","image/tiff","image/bmp"],requestHeaders:{},requestPostData:{}},v=l.w("files.length files.@each.statusType"),A={URL_REQUIRED:"Droplet: You must specify the URL parameter when constructing your component."};e.Droplet=u.create({url:function(){throw new Error(A.URL_REQUIRED)},model:m,options:{},hooks:{},files:[],statusTypes:h,init:function(){var e=this;c(this,"files",[]),c(this,"hooks",{}),Object.keys(y).forEach(function(t){c(e,"options."+t,y[t])}),this._super()},invokeHook:function(e){for(var t=f(this,"hooks")[e]||function(){},r=arguments.length,n=Array(r>1?r-1:0),i=1;r>i;i++)n[i-1]=arguments[i];t.apply(void 0,n)},uploadStatus:p(function(){return{uploading:!1,percentComplete:0,error:!1}}),validFiles:(n=p(function(){return this.getFiles(h.VALID)})).property.apply(n,_toConsumableArray(v)),invalidFiles:(i=p(function(){return this.getFiles(h.INVALID)})).property.apply(i,_toConsumableArray(v)),uploadedFiles:(s=p(function(){return this.getFiles(h.UPLOADED)})).property.apply(s,_toConsumableArray(v)),deletedFiles:(a=p(function(){return this.getFiles(h.DELETED)})).property.apply(a,_toConsumableArray(v)),deletedModels:(o=p(function(){return this.getFiles(h.DELETED)})).property.apply(o,_toConsumableArray(v)),requestSize:p(function(){return f(this,"validFiles").reduce(function(e,t){return e+t.getFileSize()},0)}).property(v),getFiles:function(e){return e?this.files.filter(function(t){return t.statusType&e}):this.files},isValid:function E(e){var t=this;if(!(e instanceof Ember.Object))return!1;var r=function(e){return function(){var r=t.get("options.mimeTypes").some(function(e){return e instanceof RegExp}),n=f(t,"options.mimeTypes");return r?n.some(function(t){var r=t===e,n=!!e.match(t);return r||n}):!!~n.indexOf(e)}},n=function(e){return function(){return e<=Number(f(t,"options.maximumSize"))}},i=function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return function(e){return t.reverse().every(function(t){return t(e)})}},E=i(r(e.getMIMEType()),n(e.getFileSize()));return E(e)},getFormData:function(){var t=new e.FormData,r=this.get("options.useArray")?"file[]":"file",n=this.get("options.requestPostData"),i=f(this,"validFiles").map(function(e){return e.file});return t.append(r,i),Object.keys(n).forEach(function(e){t.append(e,n[e])}),t},addProgressListener:function(e){return void e},addSuccessListener:function(e){return void e},addErrorListener:function(e){return void e},getRequest:function(){var e=this,r=function(e){return"function"==typeof e},n=r(f(this,"url"))?f(this,"url").apply(this):f(this,"url"),i=f(this,"options.requestMethod")||"POST",s=this.getFormData(),a=this.get("requestHeaders"),o=t.$.ajax({url:n,method:i,headers:a,data:s,processData:!1,contentType:!1,xhr:function u(){var u=t.$.ajaxSettings.xhr();return e.addProgressListener(u.upload),e.addSuccessListener(u.upload),e.addErrorListener(u.upload),c(e,"lastRequest",u),u}});return c(this,"lastResolver",o),o},actions:{uploadFiles:function(){var e=this,r=f(this,"files").filter(function(e){return e.statusType&h.VALID}),n=this.getRequest();c(this,"uploadStatus.uploading",!0),c(this,"uploadStatus.error",!1);var i=function(t,i){e.invokeHook("promiseResolver",t,i,r),n.done(t).fail(i)},s=function(t){e.invokeHook.apply(e,["didUpload"].concat(_toConsumableArray(t.files))),r.map(function(e){return e.setStatusType(h.UPLOADED)})},a=function(t){var r=t.request,n=t.textStatus,i=t.errorThrown;c(e,"uploadStatus.error",{request:r,textStatus:n,errorThrown:i})},o=function(){c(e,"uploadStatus.uploading",!1),e.invokeHook("didComplete")};return new t.RSVP.Promise(i).then(s,a)["finally"](o)},abortUpload:function(){var e=f(this,"lastResolver");e&&f(this,"uploadStatus.uploading")&&(e.abort(),c(this,"uploadStatus.uploading",!1))},mimeTypes:function(e){var t=arguments.length<=1||void 0===arguments[1]?g.PUSH:arguments[1];t===g.SET&&c(this,"options.mimeTypes",[]),e=Array.isArray(e)?e:[e];var r=[].concat(_toConsumableArray(f(this,"options.mimeTypes")),_toConsumableArray(e));c(this,"options.mimeTypes",r)},addFiles:function(){for(var e=this,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];var i=r.map(function(t){return t instanceof Ember.Object?(t.setStatusType(e.isValid(t)?h.VALID:h.INVALID),f(e,"files").pushObject(t),t):void 0}).filter(function(e){return"undefined"!=typeof e});i.length&&this.invokeHook.apply(this,["didAdd"].concat(_toConsumableArray(i)))},prepareFiles:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];t=Array.from?Array.from(t):Array.prototype.slice.call(t);var n=t.reduce(function(e,t){var r=m.create({file:t});return e.push(r),e},[]);return this.send.apply(this,["addFiles"].concat(_toConsumableArray(n))),n},deleteFiles:function(){for(var e=this,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];var i=r.map(function(t){var r=!!~f(e,"files").indexOf(t);return r?(t.setStatusType(h.DELETED),t):void 0}).filter(function(e){return"undefined"!=typeof e});i.length&&this.invokeHook.apply(this,["didDelete"].concat(_toConsumableArray(i)))},clearFiles:function(){var e=this;this.files.forEach(function(t){return e.send("deleteFiles",t)})}}});var D=function(e){e.preventDefault(),e.stopPropagation()};e.Droplet.Area=u.create({classNames:["droppable"],getParent:function(){return this.context.get("parentView")||{}},drop:function(e){return D(e),this.handleFiles(e.dataTransfer.files)},handleFiles:function(e){if(e.length&&this.getParent().send){var t;(t=this.getParent()).send.apply(t,["prepareFiles"].concat(_toConsumableArray(e)))}return e},dragEnter:D,dragOver:D,dragLeave:D}),e.Droplet.Preview=u.create({tagName:"img",attributeBindings:["src"],reader:r,image:{file:{type:""}},isImage:function(e){return!!e.type.match(/^image\//i)},didInsertElement:function(){var e=this,t=this.get("reader"),r=new t,n=f(this,"image.file");return this.isImage(n)?(r.addEventListener("load",d.bind(this,function(t){c(e,"src",t.target.result)})),void r.readAsDataURL(n)):void this.destroy()}}),e.Droplet.MultipleInput=u.create({tagName:"input",classNames:"files",attributeBindings:["disabled","name","type","multiple"],type:"file",multiple:"multiple",change:function(){var e=this.get("element"),t=Array.isArray(e.files)?e.files:[e.files];this.handleFiles(t)},handleFiles:function(e){var t;(t=this.get("parentView")).send.apply(t,["prepareFiles"].concat(_toConsumableArray(e)))}}),e.Droplet.SingleInput=u.create(e.Droplet.MultipleInput,{multiple:!1})}(window,window.Ember,window.FileReader);