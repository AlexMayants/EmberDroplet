"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();!function(e,t,r){var n=t.Mixin,i=t.String,s=t.computed,a=t.get,o=t.set,u=t.run,l={NONE:0,VALID:1,INVALID:2,DELETED:4,UPLOADED:8,FAILED:16},f=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,e),this.file=t,this.statusType=l.NONE}return _createClass(e,[{key:"getMIMEType",value:function(){return this.file.type||""}},{key:"getFileSize",value:function(){return"undefined"!=typeof this.file.size?this.file.size:1/0}},{key:"setStatusType",value:function(e){this.statusType=Number(e)}}]),e}(),c={PUSH:"push",SET:"set"},d={requestMethod:"POST",maximumSize:1/0,includeHeader:!0,useArray:!1,mimeTypes:["image/jpeg","image/jpg","image/gif","image/png","image/tiff","image/bmp"]},p=i.w("files.length","files.@each.statusType"),h={URL_REQUIRED:"Droplet: You must specify the URL parameter when constructing your component."};e.Droplet=n.create({url:function(){throw new Error(h.URL_REQUIRED)},options:{},hooks:{didAdd:function(){},didDelete:function(){},didUpload:function(){}},files:[],model:f,statusTypes:l,init:function(){var e=this;o(this,"files",[]),o(this,"hooks",{didAdd:function(){},didDelete:function(){},didUpload:function(){}}),Object.keys(d).forEach(function(t){o(e,"options."+t,d[t])}),this._super()},invokeHook:function(e){for(var t=a(this,"hooks")[e]||function(){},r=arguments.length,n=Array(r>1?r-1:0),i=1;r>i;i++)n[i-1]=arguments[i];t.apply(void 0,n)},uploadStatus:s(function(){return{uploading:!1,percentComplete:0,error:!1}}),validFiles:s(function(){return this.getFiles(l.VALID)}).property(p),invalidFiles:s(function(){return this.getFiles(l.INVALID)}).property(p),uploadedFiles:s(function(){return this.getFiles(l.UPLOADED)}).property(p),deletedFiles:s(function(){return this.getFiles(l.DELETED)}).property(p),requestSize:s(function(){return a(this,"validFiles").reduce(function(e,t){return e+t.getFileSize()},0)}).property(p),getFiles:function(e){return this.files.filter(function(t){return t.statusType&e})},isValid:function g(e){var t=this,r=function(e){return function(){var r=t.get("options.mimeTypes").some(function(e){return e instanceof RegExp}),n=a(t,"options.mimeTypes");return r?n.some(function(t){var r=t===e,n=!!e.match(t);return r||n}):!!~n.indexOf(e)}},n=function(e){return function(){return e<=Number(a(t,"options.maximumSize"))}},i=function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return function(e){return t.reverse().every(function(t){return t(e)})}},g=i(r(e.getMIMEType()),n(e.getFileSize()));return g(e)},getFormData:function(){return{}},getHeaders:function(){return{}},addProgressListener:function(e){},addSuccessListener:function(e){},addErrorListener:function(e){},getRequest:function(){var e=this,r=function(e){return"function"==typeof e},n=r(a(this,"url"))?a(this,"url").apply(this):a(this,"url"),i=a(this,"options.requestMethod")||"POST",s=this.getFormData(),u=this.getHeaders(),l=t.$.ajax({url:n,method:i,headers:u,data:s,processData:!1,contentType:!1,xhr:function f(){var f=t.$.ajaxSettings.xhr();return e.addProgressListener(f.upload),e.addSuccessListener(f.upload),e.addErrorListener(f.upload),o(e,"lastRequest",f),f}});return o(this,"lastResolver",l),l},actions:{uploadFiles:function(){var e=this,r=a(this,"files").filter(function(e){return e.statusType&l.VALID}),n=this.getRequest();o(this,"uploadStatus.uploading",!0),o(this,"uploadStatus.error",!1);var i=function(t,i){e.invokeHook("promiseResolver",t,i,r),n.done(t).fail(i)},s=function(t){e.invokeHook.apply(e,["didUpload"].concat(_toConsumableArray(t.files)))},u=function(t){var r=t.request,n=t.textStatus,i=t.errorThrown;o(e,"uploadStatus.error",{request:r,textStatus:n,errorThrown:i})},f=function(){o(e,"uploadStatus.uploading",!1),e.invokeHook("didComplete")};return new t.RSVP.Promise(i).then(s,u)["finally"](f)},abortUpload:function(){var e=a(this,"lastResolver");e&&a(this,"uploadStatus.uploading")&&(e.abort(),o(this,"uploadStatus.uploading",!1))},mimeTypes:function(e){var t=arguments.length<=1||void 0===arguments[1]?c.PUSH:arguments[1];t===c.SET&&o(this,"options.mimeTypes",[]),e=Array.isArray(e)?e:[e];var r=[].concat(_toConsumableArray(a(this,"options.mimeTypes")),_toConsumableArray(e));o(this,"options.mimeTypes",r)},addFiles:function(){for(var e=this,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];var i=r.map(function(t){return t instanceof f?(t.setStatusType(e.isValid(t)?l.VALID:l.INVALID),a(e,"files").pushObject(t),t):void 0}).filter(function(e){return"undefined"!=typeof e});i.length&&this.invokeHook.apply(this,["didAdd"].concat(_toConsumableArray(i)))},deleteFiles:function(){for(var e=this,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];var i=r.map(function(t){var r=!!~a(e,"files").indexOf(t);return r&&t instanceof f?(t.setStatusType(l.DELETED),a(e,"files").removeObject(t),t):void 0}).filter(function(e){return"undefined"!=typeof e});i.length&&this.invokeHook.apply(this,["didDelete"].concat(_toConsumableArray(i)))},clearFiles:function(){var e=this;this.files.forEach(function(t){return e.send("deleteFiles",t)}),this.files.length=0}}});var m=function(e){e.preventDefault(),e.stopPropagation()};e.Droplet.Area=n.create({classNames:["droppable"],parentView:function(){return this.context.get("parentView")||{}},drop:function(e){return m(e),this.traverseFiles(e.dataTransfer.files)},traverseFiles:function(e){e=Array.from?Array.from(e):Array.prototype.slice.call(e);var t=e.reduce(function(e,t){var r=new f(t);return e.push(r),e},[]);return this.addFiles(e),t},addFiles:function(e){e.length&&this.parentView().send&&this.parentView().send("addFiles",e)},dragEnter:m,dragOver:m,dragLeave:m}),e.Droplet.Preview=n.create({tagName:"img",attributeBindings:["src"],reader:new r,image:{file:{type:""}},isImage:function(e){return!!e.type.match(/^image\//i)},didInsertElement:function(){var e=this,t=this.get("reader"),r=a(this,"image.file");return this.isImage(r)?(t.addEventListener("load",u.bind(this,function(t){o(e,"src",t.target.result)})),void t.readAsDataURL(r)):void this.destroy()}}),e.Droplet.MultipleInput=n.create({tagName:"input",classNames:"files",attributeBindings:["disabled","name","type","multiple"],type:"file",multiple:"multiple",traverseFiles:function(e){this.get("parentView").traverseFiles(e)},change:function(){var e=this.get("element").files;this.traverseFiles(Array.isArray(e)?e:[e])}}),e.Droplet.SingleInput=n.create(e.Droplet.MultipleInput,{multiple:!1})}(window,window.Ember,window.FileReader);